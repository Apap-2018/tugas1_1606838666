<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.com">
  <head>
    <title th:replace="fragments/fragment :: title"></title>
    <object th:include="fragments/fragment :: css&js" th:remove="tag"></object>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  </head>

  <body>
    <nav th:replace="fragments/fragment :: navbar"></nav>

    <div class="container-fluid">
      <h3>Tambah Pegawai</h3>

      <form id="form-pegawai">
        <div class="form-group row">
          <label for="namaPegawai" class="col-2 col-form-label">Nama</label>
          <div class="col-4">
            <input type="text" class="form-control" id="namaPegawai">
          </div>
        </div>
        <div class="form-group row">
          <label for="tempatLahir" class="col-2 col-form-label">Tempat Lahir</label>
          <div class="col-4">
            <input type="text" class="form-control" id="tempatLahir">
          </div>
        </div>
        <div class="form-group row">
          <label for="tanggalLahir" class="col-2 col-form-label">Tanggal Lahir</label>
          <div class="col-4">
            <input type="date" class="form-control" id="tanggalLahir">
          </div>
        </div>
        <div class="form-group row">
          <label for="tahunMasuk" class="col-2 col-form-label">Tahun Masuk</label>
          <div class="col-4">
            <input type="number" class="form-control" id="tahunMasuk">
          </div>
        </div>
        <div class="form-group row">
          <label for="provinsi" class="col-2 col-form-label">Provinsi</label>
          <div class="col-4">
            <select class="form-control" id="provinsi">
              <option th:each="provinsi : ${listProvinsi}" th:text="${provinsi.nama}" th:value="${provinsi.nama}"></option>
            </select>
          </div>
        </div>
        <div class="form-group row">
          <label for="namaInstansi" class="col-2 col-form-label">Nama Instansi</label>
          <div class="col-4">
            <select class="form-control" id="namaInstansi">

            </select>
          </div>
        </div>
        <div class="form-group row">
          <label class="col-2 col-form-label">Jabatan</label>
          <div class="col-4" id="jabatan-section">
            <select class="form-control" id="jabatan1">

            </select>
          </div>
        </div>
        <div class="form-group row">
          <div class="col-2"></div>
          <div class="col-4">
            <a href="#" id="tambah-jabatan">Tambah Jabatan Lainnya</a>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Simpan</button>
      </form>
    </div>

    <script type="text/javascript">
      var currentIndex;
      function getJabatan() {
        $.ajax({
            method: "GET",
            contentType: "application/json",
            url: "/jabatan/get",
            cache: false,
            success : function (response) {
              console.log(response);
              for (var i = 0; i < response.result.length; i++) {
                $('select[id^="jabatan"]').filter(
                  function () {
                    return this.id.match(/\d+$/);
                }).append(
                  `<option th:value=${response.result[i]}>${response.result[i]}</option>`
                );
              };
            },
        });
      }

      function getProvinsi() {
        $.ajax({
            method: "POST",
            contentType: "application/json",
            url: "/provinsi/get/instansi",
            data: JSON.stringify( {nama: $("#provinsi").val()} ),
            cache: false,
            success : function (response) {
              for (var i = 0; i < response.result.length; i++) {
                $("#namaInstansi").append(`<option th:value=${response.result[i]}>${response.result[i]}</option>`);
              };
            },
        });
      }

      $(document).ready(function () {
        getJabatan();
        getProvinsi();
      });

      $("#provinsi").on("change", function () {
        getProvinsi();
      });

      $("#tambah-jabatan").on("click", function () {
        currentIndex = $('select[id^="jabatan"]').filter(
          function () {
            return this.id.match(/\d+$/);
        }).length;

        $("#jabatan-section").append(
          `<select class="form-control" id="jabatan${currentIndex+1}" style="margin-top:1%;">

          </select>`
        );
        getJabatan();
      });

      $("#form-pegawai").submit(function (event) {
        event.preventDefault();

        var params = {};
        params["namaPegawai"] = $("#namaPegawai").val();
        params["tempatLahir"] = $("#tempatLahir").val();
        params["tanggalLahir"] = $("#tanggalLahir").val();
        params["tahunMasuk"] = $("#tahunMasuk").val();
        params["provinsi"] = $("#provinsi").val();
        params["namaInstansi"] = $("#namaInstansi").val();
        params["listJabatan"] = [];
        for (var i = 1; i <= currentIndex+1; i++) {
          params["listJabatan"].push($(`#jabatan${i} option:selected`).html());
        }
        console.log(params);
        $.ajax({
            method: "POST",
            contentType: "application/json",
            url: "/pegawai/tambah",
            data: JSON.stringify(params),
            cache: false,
            success : function (response) {
            },
        });
      })

    </script>
  </body>
</html>
